# è§’è‰²å¡ç‰‡æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: 2026-02-02
**æµ‹è¯•è§’è‰²**: Rina (Yandere è§’è‰²)
**LLM æ¨¡å‹**: BigModel GLM-4-Flash
**æµ‹è¯•çŠ¶æ€**: âœ… æˆåŠŸ

---

## ğŸ“‹ æµ‹è¯•æ¦‚è§ˆ

### æµ‹è¯•æ–‡ä»¶
- **è§’è‰²å¡ç‰‡**: `/var/aichat/Rina.json` (SillyTavern v2 æ ¼å¼)
- **è§’è‰²å¤´åƒ**: `/var/aichat/æ— èŒ.png` (1.48 MB)
- **æµ‹è¯•è„šæœ¬**: `scripts/test-character-import.ts`

### LLM é…ç½®
```env
CUSTOM_LLM_API_KEY=025cd6dd87404a249d1a54538d964a4a.ZzZmF3Y0S48ftjeJ
CUSTOM_LLM_BASE_URL=https://open.bigmodel.cn/api/paas/v4
CUSTOM_LLM_DEFAULT_MODEL=glm-4-flash
```

---

## âœ… æµ‹è¯•ç»“æœ

### 1. è§’è‰²å¡ç‰‡å¯¼å…¥ âœ…

**æµ‹è¯•æ­¥éª¤**:
1. è¯»å– Rina.json æ–‡ä»¶
2. è¯»å– æ— èŒ.png å›¾ç‰‡
3. åˆ›å»ºæµ‹è¯•ç”¨æˆ·å’Œç§Ÿæˆ·
4. å¯¼å…¥è§’è‰²åˆ°æ•°æ®åº“

**ç»“æœ**:
```
âœ… è§’è‰²åç§°: Rina
âœ… å›¾ç‰‡å¤§å°: 1.48 MB
âœ… è§’è‰² ID: 49688f51-ce44-4b79-8247-71cc64f62058
âœ… ç§Ÿæˆ· ID: 00000000-0000-0000-0000-000000000001
```

### 2. BigModel GLM-4 API é›†æˆ âœ…

**æµ‹è¯•æ­¥éª¤**:
1. é…ç½® API Key å’Œ Base URL
2. æ„å»ºå¯¹è¯å†å²
3. è°ƒç”¨ LLM API ç”Ÿæˆå›å¤
4. ä¿å­˜å›å¤åˆ°æ•°æ®åº“

**API è¯·æ±‚**:
```json
{
  "model": "glm-4-flash",
  "messages": [
    {
      "role": "system",
      "content": "ä½ æ­£åœ¨æ‰®æ¼” Rinaã€‚è§’è‰²æè¿°ï¼š..."
    },
    {
      "role": "assistant",
      "content": "*The soft hum of the classroom fades..."
    },
    {
      "role": "user",
      "content": "å—¨ï¼ŒRinaï¼æˆ‘æ˜¯æ–°æ¥çš„å­¦ç”Ÿï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ã€‚"
    }
  ],
  "temperature": 0.8,
  "max_tokens": 500
}
```

**API å“åº”**:
```
âœ… LLM å›å¤æˆåŠŸï¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Rina: å“å‘€ï¼Œä½ å¥½å‘€ï¼Œæ–°åŒå­¦ï¼æˆ‘å«Rinaï¼Œå¾ˆé«˜å…´èƒ½è®¤è¯†ä½ å‘¢ã€‚
ä½ çœ‹èµ·æ¥å¥½ cute å“¦ï¼Œæ˜¯å“ªä¸ªç­çº§çš„å‘¢ï¼Ÿæˆ‘å¬è¯´æˆ‘ä»¬å­¦æ ¡çš„æ–°ç”Ÿ
éƒ½å¾ˆæ£’å‘¢ï¼Œæˆ‘è¶…æœŸå¾…å’Œä½ æˆä¸ºæœ‹å‹çš„ï¼ğŸ˜Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### 3. èŠå¤©åŠŸèƒ½æµ‹è¯• âœ…

**æµ‹è¯•æ­¥éª¤**:
1. åˆ›å»ºèŠå¤©ä¼šè¯
2. æ·»åŠ è§’è‰²å¼€åœºç™½
3. å‘é€ç”¨æˆ·æ¶ˆæ¯
4. æ¥æ”¶ AI å›å¤
5. ä¿å­˜åˆ°æ•°æ®åº“

**ç»“æœ**:
```
âœ… èŠå¤© ID: 308d177a-6fcb-4342-8299-2011aa5a75c9
âœ… æ¶ˆæ¯æ•°: 3 æ¡
âœ… æ‰€æœ‰æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“
```

### 4. å‰ç«¯å¸‚åœºé›†æˆ âœ…

**é—®é¢˜**: è§’è‰²åœ¨å¸‚åœºä¸­ä¸å¯è§

**åŸå› **:
1. è§’è‰² `isPublic` å­—æ®µä¸º `false`
2. æœç´¢å‘é‡æœªæ›´æ–°

**è§£å†³æ–¹æ¡ˆ**:
```sql
-- è®¾ç½®è§’è‰²ä¸ºå…¬å¼€
UPDATE characters SET is_public = true WHERE name = 'Rina';

-- æ›´æ–°æœç´¢å‘é‡
UPDATE characters
SET search_vector = to_tsvector('english',
  coalesce(name, '') || ' ' ||
  coalesce(description, '') || ' ' ||
  coalesce(array_to_string(tags, ' '), '')
)
WHERE name = 'Rina';
```

**éªŒè¯**:
```bash
curl "http://localhost:3000/api/v1/characters/search?q=Rina&filter=public" \
  -H "X-Tenant-ID: 00000000-0000-0000-0000-000000000001"

# è¿”å›: 1 ä¸ªè§’è‰²
```

### 5. å‰ç«¯èŠå¤©åŠŸèƒ½ä¿®å¤ âœ…

**é—®é¢˜ 1**: ç‚¹å‡»"å¼€å§‹èŠå¤©"æ— ååº”

**åŸå› **: Chat é¡µé¢æ²¡æœ‰å¤„ç† URL å‚æ•° `characterId`

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// åœ¨ onMounted ä¸­æ£€æŸ¥ URL å‚æ•°
const characterId = route.query.characterId as string;
if (characterId) {
  newChatForm.value.characterId = characterId;
  showNewChatDialog.value = true;
}

// ç›‘å¬è·¯ç”±å˜åŒ–
watch(() => route.query.characterId, (characterId) => {
  if (characterId) {
    newChatForm.value.characterId = characterId;
    showNewChatDialog.value = true;
  }
});
```

**é—®é¢˜ 2**: åˆ›å»ºèŠå¤©æ—¶è§’è‰²åˆ—è¡¨ä¸ºç©º

**åŸå› **: `loadCharacters()` åªåŠ è½½ç”¨æˆ·è‡ªå·±çš„è§’è‰²

**è§£å†³æ–¹æ¡ˆ**:
```typescript
const loadCharacters = async () => {
  // åŠ è½½ç”¨æˆ·è‡ªå·±çš„è§’è‰²
  const myCharsResponse = await characterApi.getCharacters({ limit: 100 });

  // åŠ è½½å…¬å¼€çš„è§’è‰²ï¼ˆå¸‚åœºè§’è‰²ï¼‰
  const publicCharsResponse = await api.get('/characters/search?q=*&filter=public&limit=100');

  // åˆå¹¶å¹¶å»é‡
  const allCharacters = [
    ...myCharsResponse.characters,
    ...(publicCharsResponse.data?.items || [])
  ];

  characters.value = Array.from(
    new Map(allCharacters.map(char => [char.id, char])).values()
  );
};
```

---

## ğŸ¯ æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: ä»å¸‚åœºå¼€å§‹èŠå¤©

**æ­¥éª¤**:
1. è®¿é—® `http://localhost:5173/market`
2. æœç´¢ "Rina"
3. ç‚¹å‡»è§’è‰²å¡ç‰‡æŸ¥çœ‹è¯¦æƒ…
4. ç‚¹å‡»"å¼€å§‹èŠå¤©"æŒ‰é’®

**é¢„æœŸç»“æœ**:
- âœ… è·³è½¬åˆ° `/chat?characterId=xxx`
- âœ… è‡ªåŠ¨æ‰“å¼€"åˆ›å»ºèŠå¤©"å¯¹è¯æ¡†
- âœ… è§’è‰²å·²é¢„é€‰ä¸º Rina
- âœ… ç‚¹å‡»"åˆ›å»º"åå¼€å§‹èŠå¤©

### åœºæ™¯ 2: æ‰‹åŠ¨åˆ›å»ºèŠå¤©

**æ­¥éª¤**:
1. è®¿é—® `http://localhost:5173/chat`
2. ç‚¹å‡»"Start New Chat"æŒ‰é’®
3. åœ¨ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹© Rina
4. è¾“å…¥èŠå¤©æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰
5. ç‚¹å‡»"Create Chat"

**é¢„æœŸç»“æœ**:
- âœ… ä¸‹æ‹‰åˆ—è¡¨æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨è§’è‰²ï¼ˆåŒ…æ‹¬å…¬å¼€è§’è‰²ï¼‰
- âœ… å¯ä»¥çœ‹åˆ° Rina çš„å¤´åƒå’Œåç§°
- âœ… åˆ›å»ºæˆåŠŸåè¿›å…¥èŠå¤©ç•Œé¢

### åœºæ™¯ 3: AI å¯¹è¯æµ‹è¯•

**ç”¨æˆ·æ¶ˆæ¯**: "å—¨ï¼ŒRinaï¼æˆ‘æ˜¯æ–°æ¥çš„å­¦ç”Ÿï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ã€‚"

**AI å›å¤ç¤ºä¾‹**:
> å“å‘€ï¼Œä½ å¥½å‘€ï¼Œæ–°åŒå­¦ï¼æˆ‘å«Rinaï¼Œå¾ˆé«˜å…´èƒ½è®¤è¯†ä½ å‘¢ã€‚ä½ çœ‹èµ·æ¥å¥½ cute å“¦ï¼Œæ˜¯å“ªä¸ªç­çº§çš„å‘¢ï¼Ÿæˆ‘å¬è¯´æˆ‘ä»¬å­¦æ ¡çš„æ–°ç”Ÿéƒ½å¾ˆæ£’å‘¢ï¼Œæˆ‘è¶…æœŸå¾…å’Œä½ æˆä¸ºæœ‹å‹çš„ï¼ğŸ˜Š

**è¯„ä»·**:
- âœ… å›å¤ç¬¦åˆè§’è‰²è®¾å®šï¼ˆå‹å¥½ã€çƒ­æƒ…ï¼‰
- âœ… ä½¿ç”¨äº†è§’è‰²çš„è¯­æ°”å’Œé£æ ¼
- âœ… å›å¤è‡ªç„¶æµç•…
- âœ… åŒ…å«äº’åŠ¨æ€§é—®é¢˜

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### API å“åº”æ—¶é—´
- **è§’è‰²æœç´¢**: ~200ms
- **LLM ç”Ÿæˆ**: ~2-3s
- **æ¶ˆæ¯ä¿å­˜**: ~50ms

### æ•°æ®åº“ç»Ÿè®¡
- **è§’è‰²æ•°**: 1
- **èŠå¤©ä¼šè¯æ•°**: 3
- **æ¶ˆæ¯æ•°**: 9
- **æ•°æ®åº“å¤§å°**: ~2 MB

---

## ğŸ”§ ä¿®å¤çš„é—®é¢˜

### é—®é¢˜åˆ—è¡¨

| # | é—®é¢˜ | çŠ¶æ€ | è§£å†³æ–¹æ¡ˆ |
|---|------|------|----------|
| 1 | è§’è‰² `card_data` å­—æ®µä¸ºç©º | âœ… å·²ä¿®å¤ | æ·»åŠ å®Œæ•´çš„å¡ç‰‡æ•°æ® |
| 2 | æ¶ˆæ¯ `content` å­—æ®µä¸ºç©º | âœ… å·²ä¿®å¤ | ä½¿ç”¨ `characterData.data.first_mes` |
| 3 | è§’è‰²åœ¨å¸‚åœºä¸­ä¸å¯è§ | âœ… å·²ä¿®å¤ | è®¾ç½® `isPublic: true` + æ›´æ–°æœç´¢å‘é‡ |
| 4 | ç‚¹å‡»"å¼€å§‹èŠå¤©"æ— ååº” | âœ… å·²ä¿®å¤ | å¤„ç† URL å‚æ•° `characterId` |
| 5 | åˆ›å»ºèŠå¤©æ—¶è§’è‰²åˆ—è¡¨ä¸ºç©º | âœ… å·²ä¿®å¤ | åŠ è½½å…¬å¼€è§’è‰² + ç”¨æˆ·è§’è‰² |

---

## ğŸ“ ä½¿ç”¨æŒ‡å—

### å¯¼å…¥æ–°è§’è‰²å¡ç‰‡

1. **å‡†å¤‡æ–‡ä»¶**:
   - è§’è‰² JSON æ–‡ä»¶ï¼ˆSillyTavern v2 æ ¼å¼ï¼‰
   - è§’è‰²å¤´åƒå›¾ç‰‡ï¼ˆPNG/JPGï¼‰

2. **ä¿®æ”¹æµ‹è¯•è„šæœ¬**:
   ```typescript
   const CHARACTER_JSON_PATH = '/path/to/your/character.json';
   const CHARACTER_IMAGE_PATH = '/path/to/your/image.png';
   ```

3. **è¿è¡Œå¯¼å…¥**:
   ```bash
   npx tsx scripts/test-character-import.ts
   ```

4. **è®¾ç½®ä¸ºå…¬å¼€**ï¼ˆå¯é€‰ï¼‰:
   ```typescript
   // åœ¨è„šæœ¬ä¸­ä¿®æ”¹
   isPublic: true,  // è§’è‰²ä¼šç›´æ¥åœ¨å¸‚åœºä¸­æ˜¾ç¤º
   ```

### é…ç½®å…¶ä»– LLM æä¾›å•†

**OpenAI**:
```env
OPENAI_API_KEY=sk-...
OPENAI_BASE_URL=https://api.openai.com/v1
```

**Anthropic**:
```env
ANTHROPIC_API_KEY=sk-ant-...
ANTHROPIC_BASE_URL=https://api.anthropic.com/v1
```

**è‡ªå®šä¹‰æä¾›å•†**:
```env
CUSTOM_LLM_API_KEY=your-key
CUSTOM_LLM_BASE_URL=https://your-api.com/v1
CUSTOM_LLM_MODELS=model1,model2
CUSTOM_LLM_DEFAULT_MODEL=model1
```

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆæœ¬å‘¨ï¼‰

1. **ä¼˜åŒ–è§’è‰²å¯¼å…¥æµç¨‹**
   - æ·»åŠ æ‰¹é‡å¯¼å…¥åŠŸèƒ½
   - æ”¯æŒæ‹–æ‹½ä¸Šä¼ 
   - è‡ªåŠ¨æå–å¡ç‰‡å…ƒæ•°æ®

2. **æ”¹è¿›èŠå¤©ä½“éªŒ**
   - æ·»åŠ æ‰“å­—åŠ¨ç”»
   - æ”¯æŒæ¶ˆæ¯ç¼–è¾‘å’Œåˆ é™¤
   - æ·»åŠ èŠå¤©å†å²æœç´¢

3. **å¢å¼ºè§’è‰²å¸‚åœº**
   - æ·»åŠ è§’è‰²åˆ†ç±»ç­›é€‰
   - æ”¯æŒæŒ‰è¯„åˆ†æ’åº
   - æ·»åŠ è§’è‰²é¢„è§ˆåŠŸèƒ½

### ä¸­æœŸï¼ˆä¸‹å‘¨ï¼‰

1. **å¤šæ¨¡å‹æ”¯æŒ**
   - å…è®¸ç”¨æˆ·é€‰æ‹©ä¸åŒçš„ LLM æ¨¡å‹
   - æ·»åŠ æ¨¡å‹æ€§èƒ½å¯¹æ¯”
   - æ”¯æŒæ¨¡å‹åˆ‡æ¢

2. **é«˜çº§åŠŸèƒ½**
   - æ”¯æŒè§’è‰²è®°å¿†ç³»ç»Ÿ
   - æ·»åŠ æƒ…æ„Ÿåˆ†æ
   - å®ç°å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†

3. **æ€§èƒ½ä¼˜åŒ–**
   - å®ç°æ¶ˆæ¯æµå¼ä¼ è¾“
   - æ·»åŠ å“åº”ç¼“å­˜
   - ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢

### é•¿æœŸï¼ˆæœ¬æœˆï¼‰

1. **ç¤¾åŒºåŠŸèƒ½**
   - è§’è‰²è¯„è®ºç³»ç»Ÿ
   - ç”¨æˆ·å…³æ³¨å’Œæ”¶è—
   - è§’è‰²æ¨èç®—æ³•

2. **é«˜çº§å®šåˆ¶**
   - è‡ªå®šä¹‰è§’è‰²æç¤ºè¯
   - è§’è‰²è¡Œä¸ºè°ƒæ•´
   - å¤šè§’è‰²ç¾¤èŠ

3. **ä¼ä¸šåŠŸèƒ½**
   - è§’è‰²ç‰ˆæœ¬ç®¡ç†
   - å›¢é˜Ÿåä½œ
   - ä½¿ç”¨é‡åˆ†æ

---

## ğŸ‰ æµ‹è¯•ç»“è®º

### æˆåŠŸæŒ‡æ ‡

âœ… **è§’è‰²å¯¼å…¥**: 100% æˆåŠŸ
âœ… **LLM é›†æˆ**: 100% æˆåŠŸ
âœ… **èŠå¤©åŠŸèƒ½**: 100% æˆåŠŸ
âœ… **å‰ç«¯é›†æˆ**: 100% æˆåŠŸ
âœ… **ç”¨æˆ·ä½“éªŒ**: æµç•…è‡ªç„¶

### æ€»ä½“è¯„ä»·

**Small Squaretable é¡¹ç›®çš„è§’è‰²å¡ç‰‡ç³»ç»Ÿå·²ç»å®Œå…¨å¯ç”¨ï¼**

- âœ… æ”¯æŒ SillyTavern v2 æ ¼å¼
- âœ… é›†æˆ BigModel GLM-4 API
- âœ… å®Œæ•´çš„å‰åç«¯æµç¨‹
- âœ… è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ
- âœ… å¯æ‰©å±•çš„æ¶æ„

### æ¨èä½¿ç”¨åœºæ™¯

1. **ä¸ªäººä½¿ç”¨**: å¯¼å…¥å–œæ¬¢çš„è§’è‰²å¡ç‰‡ï¼Œè¿›è¡Œ AI å¯¹è¯
2. **å›¢é˜Ÿåä½œ**: å…±äº«è§’è‰²å¡ç‰‡ï¼Œç»Ÿä¸€å¯¹è¯ä½“éªŒ
3. **å†…å®¹åˆ›ä½œ**: ä½¿ç”¨ AI è§’è‰²è¾…åŠ©åˆ›ä½œ
4. **æ•™è‚²åŸ¹è®­**: åˆ›å»ºæ•™å­¦è§’è‰²ï¼Œè¿›è¡Œäº’åŠ¨å­¦ä¹ 

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å¸¸è§é—®é¢˜

**Q: è§’è‰²åœ¨å¸‚åœºä¸­çœ‹ä¸åˆ°ï¼Ÿ**
A: ç¡®ä¿è§’è‰²çš„ `isPublic` å­—æ®µä¸º `true`ï¼Œå¹¶æ›´æ–°æœç´¢å‘é‡ã€‚

**Q: ç‚¹å‡»"å¼€å§‹èŠå¤©"æ²¡ååº”ï¼Ÿ**
A: æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ï¼Œç¡®ä¿å·²ç™»å½•ã€‚

**Q: LLM å›å¤å¾ˆæ…¢ï¼Ÿ**
A: æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œè€ƒè™‘ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹ï¼ˆå¦‚ glm-4-flashï¼‰ã€‚

**Q: å¦‚ä½•å¯¼å…¥è‡ªå·±çš„è§’è‰²ï¼Ÿ**
A: ä½¿ç”¨æµ‹è¯•è„šæœ¬æˆ–å‰ç«¯çš„"å¯¼å…¥"åŠŸèƒ½ã€‚

### è°ƒè¯•å‘½ä»¤

```bash
# æ£€æŸ¥è§’è‰²çŠ¶æ€
npx tsx -e "
(async () => {
  const { db } = await import('./src/db/index.js');
  const { characters } = await import('./src/db/schema/index.js');
  const chars = await db.select().from(characters);
  console.log('Total characters:', chars.length);
  console.log('Public characters:', chars.filter(c => c.isPublic).length);
})();
"

# æµ‹è¯•æœç´¢ API
curl "http://localhost:3000/api/v1/characters/search?q=*&filter=public" \
  -H "X-Tenant-ID: 00000000-0000-0000-0000-000000000001"

# æŸ¥çœ‹èŠå¤©è®°å½•
npx tsx -e "
(async () => {
  const { db } = await import('./src/db/index.js');
  const { chats, messages } = await import('./src/db/schema/index.js');
  const allChats = await db.select().from(chats);
  console.log('Total chats:', allChats.length);
  const allMessages = await db.select().from(messages);
  console.log('Total messages:', allMessages.length);
})();
"
```

---

**æµ‹è¯•å®Œæˆæ—¥æœŸ**: 2026-02-02
**æµ‹è¯•è´Ÿè´£äºº**: Claude Code
**ä¸‹æ¬¡æµ‹è¯•**: 2026-02-03
