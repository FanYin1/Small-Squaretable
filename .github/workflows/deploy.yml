name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Docker image tag to deploy (default: latest)'
        required: false
        default: 'latest'
        type: string
      skip_smoke_test:
        description: 'Skip smoke tests after deployment'
        required: false
        default: false
        type: boolean
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      image_tag: ${{ steps.set-env.outputs.image_tag }}
    steps:
      - name: Set environment variables
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "image_tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "image_tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          fi

  verify-image:
    name: Verify Docker Image
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify image exists
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.image_tag }}"
          echo "Verifying image: $IMAGE"
          docker manifest inspect $IMAGE || {
            echo "Error: Image $IMAGE not found in registry"
            exit 1
          }
          echo "Image verified successfully"

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [prepare, verify-image]
    if: needs.prepare.outputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.small-squaretable.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.3.0'

      - name: Update image tag in Kustomize
        run: |
          cd k8s/overlays/staging
          kustomize edit set image app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.image_tag }}

      - name: Deploy to Kubernetes
        run: |
          kustomize build k8s/overlays/staging | kubectl apply -f -

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/small-squaretable -n staging --timeout=300s

      - name: Verify deployment
        run: |
          kubectl get pods -n staging -l app=small-squaretable
          kubectl get services -n staging -l app=small-squaretable

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [prepare, verify-image]
    if: needs.prepare.outputs.environment == 'production'
    environment:
      name: production
      url: https://small-squaretable.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_PRODUCTION }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.3.0'

      - name: Update image tag in Kustomize
        run: |
          cd k8s/overlays/production
          kustomize edit set image app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.image_tag }}

      - name: Deploy to Kubernetes
        run: |
          kustomize build k8s/overlays/production | kubectl apply -f -

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/small-squaretable -n production --timeout=600s

      - name: Verify deployment
        run: |
          kubectl get pods -n production -l app=small-squaretable
          kubectl get services -n production -l app=small-squaretable

  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [prepare, deploy-staging, deploy-production]
    if: |
      always() &&
      (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success') &&
      github.event.inputs.skip_smoke_test != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set target URL
        id: target
        run: |
          if [[ "${{ needs.prepare.outputs.environment }}" == "production" ]]; then
            echo "url=https://small-squaretable.example.com" >> $GITHUB_OUTPUT
          else
            echo "url=https://staging.small-squaretable.example.com" >> $GITHUB_OUTPUT
          fi

      - name: Health check
        run: |
          echo "Running health check against ${{ steps.target.outputs.url }}"
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.target.outputs.url }}/health" || echo "000")
            if [[ "$response" == "200" ]]; then
              echo "Health check passed"
              exit 0
            fi
            echo "Attempt $i: Got response $response, retrying in 10s..."
            sleep 10
          done
          echo "Health check failed after 5 attempts"
          exit 1

      - name: API readiness check
        run: |
          echo "Running API readiness check"
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.target.outputs.url }}/health/ready")
          if [[ "$response" != "200" ]]; then
            echo "API readiness check failed with status $response"
            exit 1
          fi
          echo "API readiness check passed"

      - name: Basic API test
        run: |
          echo "Testing API endpoints"
          # Test auth endpoint exists
          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${{ steps.target.outputs.url }}/api/v1/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"test@test.com","password":"test"}')
          # We expect 401 or 400, not 500 or 404
          if [[ "$response" == "500" ]] || [[ "$response" == "404" ]]; then
            echo "API test failed: endpoint returned $response"
            exit 1
          fi
          echo "API endpoint test passed (got expected response: $response)"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [prepare, deploy-staging, deploy-production, smoke-test]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.prepare.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: ${{ needs.prepare.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered By**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.prepare.outputs.environment }}" == "staging" ]]; then
            echo "- **Staging Deploy**: ${{ needs.deploy-staging.result }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Production Deploy**: ${{ needs.deploy-production.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "- **Smoke Tests**: ${{ needs.smoke-test.result }}" >> $GITHUB_STEP_SUMMARY
